/* Este procedure sirve para generar asistencia por defecto (todos ausentes) de los alumnos inscriptos
en un determinado curso. El curso debe tener dias asignados y alumnos inscriptos para poder correr este procedimiento*/

CREATE PROC SP_GENERAR_ASISTENCIA(@ID_CURSO INT)
AS BEGIN


DECLARE @ID_CLASE INT 
DECLARE @CICLO INT
DECLARE @ID_CURSO_ALUMNO INT
DECLARE @MAXID INT
DECLARE  CUR CURSOR FOR SELECT ID_CLASE FROM CLASE WHERE ID_CURSO=@ID_CURSO
OPEN CUR
FETCH CUR INTO @ID_CLASE
SET @CICLO = @@FETCH_STATUS
WHILE  @CICLO= 0
BEGIN
	DECLARE CURA CURSOR FOR SELECT ID_CURSO_ALUMNO FROM CURSO_ALUMNOS WHERE ID_CURSO=@ID_CURSO
	OPEN CURA
	FETCH CURA INTO @ID_CURSO_ALUMNO 
	WHILE @@FETCH_STATUS = 0 
	BEGIN

		IF NOT EXISTS (SELECT 1 FROM ASISTENCIA WHERE  ID_CURSO_ALUMNO = @ID_CURSO_ALUMNO AND ID_CLASE = @ID_CLASE) 
		BEGIN
			SELECT @MAXID = ISNULL(MAX(ID_ASISTENCIA),0) FROM ASISTENCIA
			INSERT INTO ASISTENCIA VALUES (@MAXID +1,@ID_CURSO_ALUMNO,@ID_CLASE,0) 
		END
		FETCH CURA INTO @ID_CURSO_ALUMNO 
	END
	CLOSE CURA
	DEALLOCATE CURA

	FETCH CUR INTO @ID_CLASE
	SET @CICLO = @@FETCH_STATUS
END
CLOSE CUR
DEALLOCATE CUR



END